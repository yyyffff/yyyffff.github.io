

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/128.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="yyyffff">
  <meta name="keywords" content="">
  
    <meta name="description" content="LuCI框架LuCI框架就是用 Lua 写的 OpneWrt 路由器 Web 控制面板框架 使用 MVC 结构，分成三层：    层 作用    Model 调系统配置（UCI），负责数据   View 网页界面（HTML模板）   Controller 路由逻辑，处理请求   如何判断？看系统里有没有 1&#x2F;usr&#x2F;lib&#x2F;lua&#x2F;luci&#x2F;  如果有的话，基本就是了 Lua文件调用链分析在 sq">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2023-34644复现">
<meta property="og:url" content="http://yyyffff.github.io/2025/11/20/CVE-2023-34644%E5%A4%8D%E7%8E%B0/index.html">
<meta property="og:site_name" content="yyyffff&#39;s blog">
<meta property="og:description" content="LuCI框架LuCI框架就是用 Lua 写的 OpneWrt 路由器 Web 控制面板框架 使用 MVC 结构，分成三层：    层 作用    Model 调系统配置（UCI），负责数据   View 网页界面（HTML模板）   Controller 路由逻辑，处理请求   如何判断？看系统里有没有 1&#x2F;usr&#x2F;lib&#x2F;lua&#x2F;luci&#x2F;  如果有的话，基本就是了 Lua文件调用链分析在 sq">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://yyyffff.github.io/2025/05/19/IO_FILE%20Exploit/1765095173939.png">
<meta property="og:image" content="http://yyyffff.github.io/2025/05/19/IO_FILE%20Exploit/1765095264944.png">
<meta property="og:image" content="http://yyyffff.github.io/2025/05/19/IO_FILE%20Exploit/1765095324186.png">
<meta property="og:image" content="http://yyyffff.github.io/2025/05/19/IO_FILE%20Exploit/1765097769984.png">
<meta property="og:image" content="http://yyyffff.github.io/2025/05/19/IO_FILE%20Exploit/1765204723652.png">
<meta property="og:image" content="http://yyyffff.github.io/2025/05/19/IO_FILE%20Exploit/1766162836354.png">
<meta property="article:published_time" content="2025-11-20T14:00:09.000Z">
<meta property="article:modified_time" content="2025-12-19T16:47:58.022Z">
<meta property="article:author" content="yyyffff">
<meta property="article:tag" content="漏洞复现">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://yyyffff.github.io/2025/05/19/IO_FILE%20Exploit/1765095173939.png">
  
  
  
  <title>CVE-2023-34644复现 - yyyffff&#39;s blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"yyyffff.github.io","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":"2bkS2AvQTqNk4TIsyxh4ew9q-gzGzoHsz","app_key":"GfRH0zMaM1USTNT6w25DTqu8","server_url":"https://2bks2avq.lc-cn-n1-shared.com","path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  
    
  



  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>yyyffff</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="CVE-2023-34644复现"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-11-20 22:00" pubdate>
          2025年11月20日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          5.4k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          46 分钟
        
      </span>
    

    
    
      
        <span id="leancloud-page-views-container" class="post-meta" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="leancloud-page-views"></span> 次
        </span>
        
      
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">CVE-2023-34644复现</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="LuCI框架"><a href="#LuCI框架" class="headerlink" title="LuCI框架"></a>LuCI框架</h1><h2 id="LuCI框架-1"><a href="#LuCI框架-1" class="headerlink" title="LuCI框架"></a>LuCI框架</h2><p>就是用 Lua 写的 OpneWrt 路由器 Web 控制面板框架</p>
<p>使用 MVC 结构，分成三层：</p>
<table>
<thead>
<tr>
<th>层</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>Model</td>
<td>调系统配置（UCI），负责数据</td>
</tr>
<tr>
<td>View</td>
<td>网页界面（HTML模板）</td>
</tr>
<tr>
<td>Controller</td>
<td>路由逻辑，处理请求</td>
</tr>
</tbody></table>
<p>如何判断？看系统里有没有</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/lua/</span>luci<span class="hljs-operator">/</span><br></code></pre></td></tr></table></figure>

<p>如果有的话，基本就是了</p>
<h1 id="Lua文件调用链分析"><a href="#Lua文件调用链分析" class="headerlink" title="Lua文件调用链分析"></a>Lua文件调用链分析</h1><p>在 squashfs-root&#x2F;usr&#x2F;lib&#x2F;lua&#x2F;luci&#x2F;controller&#x2F;eweb&#x2F;api.lua l 文件下</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- API集合</span><br><span class="hljs-built_in">module</span>(<span class="hljs-string">&quot;luci.controller.eweb.api&quot;</span>, <span class="hljs-built_in">package</span>.<span class="hljs-built_in">seeall</span>)<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">index</span><span class="hljs-params">()</span></span><br>    <span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">authenticator</span><span class="hljs-params">(validator)</span></span><br>        <span class="hljs-keyword">local</span> http = <span class="hljs-built_in">require</span> <span class="hljs-string">&quot;luci.http&quot;</span><br>        <span class="hljs-keyword">local</span> sid = http.formvalue(<span class="hljs-string">&quot;auth&quot;</span>, <span class="hljs-literal">true</span>) <span class="hljs-keyword">or</span> <span class="hljs-literal">false</span><br><br>        <span class="hljs-keyword">if</span> sid <span class="hljs-keyword">then</span> <span class="hljs-comment">-- if authentication token was given</span><br>            <span class="hljs-keyword">local</span> sauth = <span class="hljs-built_in">require</span> <span class="hljs-string">&quot;luci.sauth&quot;</span><br>            sid = sid:<span class="hljs-built_in">match</span>(<span class="hljs-string">&quot;^[a-f0-9]*$&quot;</span>)<br>            <span class="hljs-keyword">local</span> sdat = sauth.<span class="hljs-built_in">read</span>(sid)<br>            <span class="hljs-keyword">if</span> sdat <span class="hljs-keyword">then</span> <span class="hljs-comment">-- if given token is valid</span><br>                <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(sdat) == <span class="hljs-string">&quot;table&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-comment">-- and sdat.rip == http.getenv(&quot;REMOTE_ADDR&quot;) then</span><br>                    <span class="hljs-keyword">return</span> sdat<br>                <span class="hljs-keyword">end</span><br>            <span class="hljs-keyword">end</span><br>        <span class="hljs-keyword">end</span><br>        <span class="hljs-keyword">local</span> tool = <span class="hljs-built_in">require</span> <span class="hljs-string">&quot;luci.utils.tool&quot;</span><br>        <span class="hljs-keyword">local</span> _ok, _auth = tool.doCheck()<br>        <span class="hljs-keyword">if</span> _ok <span class="hljs-keyword">and</span> _auth <span class="hljs-keyword">then</span><br>            <span class="hljs-keyword">return</span> &#123;sid = _auth, token = _auth&#125;<br>        <span class="hljs-keyword">end</span><br>        <span class="hljs-comment">-- 执行代理请求失败时，不退出主设备的</span><br>        <span class="hljs-comment">-- 场景：在AP列表代理配置AP去重启设备，重启完成后AP的session没了但是不要退出主设备的EWEB</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">string</span>.<span class="hljs-built_in">match</span>(http.<span class="hljs-built_in">getenv</span>(<span class="hljs-string">&#x27;HTTP_REFERER&#x27;</span>) <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;^.+/snos_red_%d+\.%d+\.%d+\.%d+/.+&quot;</span>) <span class="hljs-keyword">then</span><br>            tool.logout()<br>        <span class="hljs-keyword">end</span><br>        http.<span class="hljs-built_in">status</span>(<span class="hljs-number">403</span>, <span class="hljs-string">&quot;Forbidden Api&quot;</span>)<br>        http.write_json(&#123;code = <span class="hljs-number">2</span>, msg = <span class="hljs-string">&quot;403 Forbidden, auth is not passed&quot;</span>&#125;)<br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">local</span> api = node(<span class="hljs-string">&quot;api&quot;</span>)<br>    api.sysauth = <span class="hljs-string">&quot;admin&quot;</span><br>    api.sysauth_authenticator = authenticator<br>    api.notemplate = <span class="hljs-literal">true</span><br><br>    entry(&#123;<span class="hljs-string">&quot;api&quot;</span>, <span class="hljs-string">&quot;auth&quot;</span>&#125;, call(<span class="hljs-string">&quot;rpc_auth&quot;</span>), <span class="hljs-literal">nil</span>).sysauth = <span class="hljs-literal">false</span><br><br>    entry(&#123;<span class="hljs-string">&quot;api&quot;</span>, <span class="hljs-string">&quot;common&quot;</span>&#125;, call(<span class="hljs-string">&quot;rpc_common&quot;</span>), <span class="hljs-literal">nil</span>)<br><br>    entry(&#123;<span class="hljs-string">&quot;api&quot;</span>, <span class="hljs-string">&quot;cmd&quot;</span>&#125;, call(<span class="hljs-string">&quot;rpc_cmd&quot;</span>), <span class="hljs-literal">nil</span>)<br><br>    entry(&#123;<span class="hljs-string">&quot;api&quot;</span>, <span class="hljs-string">&quot;system&quot;</span>&#125;, call(<span class="hljs-string">&quot;rpc_system&quot;</span>), <span class="hljs-literal">nil</span>)<br><br>    entry(&#123;<span class="hljs-string">&quot;api&quot;</span>, <span class="hljs-string">&quot;diagnose&quot;</span>&#125;, call(<span class="hljs-string">&quot;rpc_diagnose&quot;</span>), <span class="hljs-literal">nil</span>)<br><br>    entry(&#123;<span class="hljs-string">&quot;api&quot;</span>, <span class="hljs-string">&quot;overview&quot;</span>&#125;, call(<span class="hljs-string">&quot;rpc_overview&quot;</span>), <span class="hljs-literal">nil</span>)<br><br>    entry(&#123;<span class="hljs-string">&quot;api&quot;</span>, <span class="hljs-string">&quot;network&quot;</span>&#125;, call(<span class="hljs-string">&quot;rpc_network&quot;</span>), <span class="hljs-literal">nil</span>)<br><br>    entry(&#123;<span class="hljs-string">&quot;api&quot;</span>, <span class="hljs-string">&quot;wireless&quot;</span>&#125;, call(<span class="hljs-string">&quot;rpc_wireless&quot;</span>), <span class="hljs-literal">nil</span>)<br><br>    entry(&#123;<span class="hljs-string">&quot;api&quot;</span>, <span class="hljs-string">&quot;download&quot;</span>&#125;, call(<span class="hljs-string">&quot;down_file&quot;</span>), <span class="hljs-literal">nil</span>)<br><br>    entry(&#123;<span class="hljs-string">&quot;api&quot;</span>, <span class="hljs-string">&quot;switch&quot;</span>&#125;, call(<span class="hljs-string">&quot;rpc_switch&quot;</span>), <span class="hljs-literal">nil</span>)<br><br>    entry(&#123;<span class="hljs-string">&quot;api&quot;</span>, <span class="hljs-string">&quot;openvpn&quot;</span>&#125;, call(<span class="hljs-string">&quot;openvpn&quot;</span>), <span class="hljs-literal">nil</span>)<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>这里首先定义了一个模块</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-built_in">module</span>(<span class="hljs-string">&quot;luci.controller.eweb.api&quot;</span>, <span class="hljs-built_in">package</span>.<span class="hljs-built_in">seeall</span>)<br></code></pre></td></tr></table></figure>

<p>Lua 中模块的命名方式是用“点”表示层级，例如：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-tag">a</span><span class="hljs-selector-class">.b</span><span class="hljs-selector-class">.c</span>     → 文件路径 <span class="hljs-selector-tag">a</span>/<span class="hljs-selector-tag">b</span>/c<span class="hljs-selector-class">.lua</span><br></code></pre></td></tr></table></figure>

<p>这个作用是，让 LuCI 知道</p>
<ul>
<li>这个文件属于 <strong>luci.controller.eweb.api</strong> 模块 </li>
<li>文件内部的 index() 是控制器入口</li>
<li>这个文件要用于注册路由</li>
</ul>
<p>就是告诉 LuCI：这是一个控制器模块<br>而 luci.controller.eweb.api  ↔  &#x2F;usr&#x2F;lib&#x2F;lua&#x2F;luci&#x2F;controller&#x2F;eweb&#x2F;api.lua</p>
<p>LuCI 会根据这个名字去对应的路径加载文件</p>
<p>然后执行 index() 配置路由</p>
<p>路由的意思就是：比如 entry({“api”, “switch”}, call(“rpc_switch”), nil)，那么 url 路径为 &#x2F;api&#x2F;switch ，就会执行 rpc_switch</p>
<p>这里配置</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lua">entry(&#123;<span class="hljs-string">&quot;api&quot;</span>, <span class="hljs-string">&quot;auth&quot;</span>&#125;, call(<span class="hljs-string">&quot;rpc_auth&quot;</span>), <span class="hljs-literal">nil</span>).sysauth = <span class="hljs-literal">false</span><br></code></pre></td></tr></table></figure>

<p>这意味着当用户访问 &#x2F;api&#x2F;auth 路径时，将调用 rpc_auth，然后 sysauth 属性控制是否需要系统级的用户认证才可以访问该路由，这里 false 表示不需要，即无需认证即可访问 &#x2F;api&#x2F;auth</p>
<p>然后来看 rpc_auth</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- 认证模块</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rpc_auth</span><span class="hljs-params">()</span></span><br>    <span class="hljs-keyword">local</span> jsonrpc = <span class="hljs-built_in">require</span> <span class="hljs-string">&quot;luci.utils.jsonrpc&quot;</span> <span class="hljs-comment">--JSON-RPC 协议处理器</span><br>    <span class="hljs-keyword">local</span> http = <span class="hljs-built_in">require</span> <span class="hljs-string">&quot;luci.http&quot;</span> <span class="hljs-comment">--处理 HTTP 请求与响应</span><br>    <span class="hljs-keyword">local</span> ltn12 = <span class="hljs-built_in">require</span> <span class="hljs-string">&quot;luci.ltn12&quot;</span> <span class="hljs-comment">--Lua 数据流处理库，用于数据管道</span><br>    <span class="hljs-keyword">local</span> _tbl = <span class="hljs-built_in">require</span> <span class="hljs-string">&quot;luci.modules.noauth&quot;</span>  <span class="hljs-comment">--允许 无需认证访问的 RPC 方法集合。到这里都是引入了一些模块</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">tonumber</span>(http.<span class="hljs-built_in">getenv</span>(<span class="hljs-string">&quot;HTTP_CONTENT_LENGTH&quot;</span>) <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>) &gt; <span class="hljs-number">1000</span> <span class="hljs-keyword">then</span> <span class="hljs-comment">--判断HTTP_CONTENT_LENGTH是否大于1000.如果不大于，就会将http响应类型设置为 v</span><br>        http.prepare_content(<span class="hljs-string">&quot;text/plain&quot;</span>)<br>        <span class="hljs-comment">-- http.write(&#123;code = &quot;1&quot;, err = &quot;too long data&quot;&#125;)</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;too long data&quot;</span><br>    <span class="hljs-keyword">end</span><br>    http.prepare_content(<span class="hljs-string">&quot;application/json&quot;</span>)<br>    ltn12.pump.all(jsonrpc.handle(_tbl, http.source()), http.<span class="hljs-built_in">write</span>)<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>然后最后一句调用 handle，传入的是  luci.modules.noauth 文件返回的内容，类型为 table，包含 noauth 问及那定义的四个函数 login &#x2F; singleLogin &#x2F; merge &#x2F; checkNet </p>
<p>http.source() 用于从 http 请求体中读取数据</p>
<p>ltn12.pump.all( 响应源, http.write ) ，把 handle 返回的响应源所产生的所有响应数据交给 http.write ，写出到 http 响应流， 直到响应源结束  这是把“处理后的结果”最终输出给客户端的操作。 </p>
<p>然后看 luci.utils.jsonrpc 代码</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">--[[</span><br><span class="hljs-comment">LuCI - Lua Configuration Interface</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Copyright 2008 Steven Barth &lt;steven@midlink.org&gt;</span><br><span class="hljs-comment">Copyright 2008 Jo-Philipp Wich &lt;xm@leipzig.freifunk.net&gt;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span><br><span class="hljs-comment">you may not use this file except in compliance with the License.</span><br><span class="hljs-comment">You may obtain a copy of the License at</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">	http://www.apache.org/licenses/LICENSE-2.0</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">$Id$</span><br><span class="hljs-comment">]]</span> <span class="hljs-comment">--</span><br><br><span class="hljs-built_in">module</span>(<span class="hljs-string">&quot;luci.utils.jsonrpc&quot;</span>, <span class="hljs-built_in">package</span>.<span class="hljs-built_in">seeall</span>)<br><span class="hljs-built_in">require</span> <span class="hljs-string">&quot;luci.json&quot;</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">resolve</span><span class="hljs-params">(mod, method)</span></span><br>    <span class="hljs-keyword">local</span> <span class="hljs-built_in">path</span> = luci.util.split(method, <span class="hljs-string">&quot;.&quot;</span>)<br><br>    <span class="hljs-keyword">for</span> j = <span class="hljs-number">1</span>, #<span class="hljs-built_in">path</span> - <span class="hljs-number">1</span> <span class="hljs-keyword">do</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">type</span>(<span class="hljs-built_in">mod</span>) == <span class="hljs-string">&quot;table&quot;</span> <span class="hljs-keyword">then</span><br>            <span class="hljs-keyword">break</span><br>        <span class="hljs-keyword">end</span><br>        <span class="hljs-built_in">mod</span> = <span class="hljs-built_in">rawget</span>(<span class="hljs-built_in">mod</span>, <span class="hljs-built_in">path</span>[j])<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">mod</span> <span class="hljs-keyword">then</span><br>            <span class="hljs-keyword">break</span><br>        <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-built_in">mod</span> = <span class="hljs-built_in">type</span>(<span class="hljs-built_in">mod</span>) == <span class="hljs-string">&quot;table&quot;</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">rawget</span>(<span class="hljs-built_in">mod</span>, <span class="hljs-built_in">path</span>[#<span class="hljs-built_in">path</span>]) <span class="hljs-keyword">or</span> <span class="hljs-literal">nil</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(<span class="hljs-built_in">mod</span>) == <span class="hljs-string">&quot;function&quot;</span> <span class="hljs-keyword">then</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">mod</span><br>    <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span><span class="hljs-params">(tbl, rawsource, ...)</span></span><br>    <span class="hljs-keyword">local</span> decoder = luci.json.Decoder()<br>    <span class="hljs-keyword">local</span> stat, err = luci.ltn12.pump.all(rawsource, decoder:sink()) <span class="hljs-comment">--把输入源的数据全部泵到解码器的接收器里</span><br>    <span class="hljs-keyword">local</span> json = decoder:get() <span class="hljs-comment">--从 decoder 中获取完整的 json 解码结果</span><br>    <span class="hljs-keyword">local</span> response<br>    <span class="hljs-keyword">local</span> success = <span class="hljs-literal">false</span><br><br>    <span class="hljs-keyword">if</span> stat <span class="hljs-keyword">then</span> <span class="hljs-comment">--判断是否解码成功</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(json.method) == <span class="hljs-string">&quot;string&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-comment">--要求必须有 method 字段并且是字符串</span><br>            <span class="hljs-keyword">local</span> method = resolve(tbl, json.method) <span class="hljs-comment">--将 method 传给 resolve，</span><br>            <span class="hljs-keyword">if</span> method <span class="hljs-keyword">then</span><br>                response = reply(json.jsonrpc, json.id, proxy(method, json.params <span class="hljs-keyword">or</span> &#123;&#125;))<br>            <span class="hljs-keyword">else</span><br>                response = reply(json.jsonrpc, json.id, <span class="hljs-literal">nil</span>, &#123;code = <span class="hljs-number">-32601</span>, message = <span class="hljs-string">&quot;Method not found.&quot;</span>&#125;)<br>            <span class="hljs-keyword">end</span><br>        <span class="hljs-keyword">else</span><br>            response = reply(json.jsonrpc, json.id, <span class="hljs-literal">nil</span>, &#123;code = <span class="hljs-number">-32600</span>, message = <span class="hljs-string">&quot;Invalid request.&quot;</span>&#125;)<br>        <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">else</span><br>        response = reply(<span class="hljs-string">&quot;2.0&quot;</span>, <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, &#123;code = <span class="hljs-number">-32700</span>, message = <span class="hljs-string">&quot;Parse error.&quot;</span>, err = err&#125;)<br>    <span class="hljs-keyword">end</span><br><br>    <span class="hljs-keyword">return</span> luci.json.Encoder(response, ...):source()<br><span class="hljs-keyword">end</span><br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">reply</span><span class="hljs-params">(jsonrpc, id, res, err)</span></span><br>    <span class="hljs-built_in">require</span> <span class="hljs-string">&quot;luci.json&quot;</span><br>    id = id <span class="hljs-keyword">or</span> luci.json.null<br><br>    <span class="hljs-comment">-- 1.0 compatibility</span><br>    <span class="hljs-keyword">if</span> jsonrpc ~= <span class="hljs-string">&quot;2.0&quot;</span> <span class="hljs-keyword">then</span><br>        jsonrpc = <span class="hljs-literal">nil</span><br>        res = res <span class="hljs-keyword">or</span> luci.json.null<br>        err = err <span class="hljs-keyword">or</span> luci.json.null<br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-comment">-- if type(res) == &quot;string&quot; then</span><br>    <span class="hljs-comment">--     res = luci.json.decode(res) or res</span><br>    <span class="hljs-comment">-- end</span><br>    <span class="hljs-keyword">return</span> &#123;id = id, data = res, <span class="hljs-built_in">error</span> = err, jsonrpc = jsonrpc, code = <span class="hljs-number">0</span>&#125;<br><span class="hljs-keyword">end</span><br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">proxy</span><span class="hljs-params">(method, ...)</span></span><br>    <span class="hljs-keyword">local</span> tool = <span class="hljs-built_in">require</span> <span class="hljs-string">&quot;luci.utils.tool&quot;</span><br>    <span class="hljs-keyword">local</span> res = &#123;luci.util.copcall(method, ...)&#125;<br>    <span class="hljs-keyword">local</span> stat = <span class="hljs-built_in">table</span>.<span class="hljs-built_in">remove</span>(res, <span class="hljs-number">1</span>)<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> stat <span class="hljs-keyword">then</span><br>        tool.<span class="hljs-built_in">debug</span>(<span class="hljs-string">&quot;[&quot;</span> .. <span class="hljs-built_in">os</span>.<span class="hljs-built_in">date</span>() .. <span class="hljs-string">&quot; -s]&quot;</span> .. <span class="hljs-string">&quot;=====      RPC ERROR LOG&quot;</span>, &#123;params = ...&#125;)<br>        <span class="hljs-comment">-- return nil, &#123;code = -32602, data = &quot;jsonrpc:81&quot;, params = ..., res = res&#125;</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, &#123;code = <span class="hljs-number">-32602</span>, data = <span class="hljs-string">&quot;jsonrpc:81&quot;</span>, res = res&#125;<br>    <span class="hljs-keyword">else</span><br>        <span class="hljs-keyword">if</span> #res &lt;= <span class="hljs-number">1</span> <span class="hljs-keyword">then</span><br>            <span class="hljs-keyword">return</span> res[<span class="hljs-number">1</span>] <span class="hljs-keyword">or</span> luci.json.null<br>        <span class="hljs-keyword">else</span><br>            tool.<span class="hljs-built_in">debug</span>(<span class="hljs-string">&quot;[&quot;</span> .. <span class="hljs-built_in">os</span>.<span class="hljs-built_in">date</span>() .. <span class="hljs-string">&quot; -s]&quot;</span> .. <span class="hljs-string">&quot;=====      RPC ERROR LOG&quot;</span>, &#123;params = ...&#125;)<br>            <span class="hljs-comment">-- return &#123;code = -32603, data = &quot;jsonrpc:89&quot;, params = ..., res = res&#125;</span><br>            <span class="hljs-keyword">return</span> &#123;code = <span class="hljs-number">-32603</span>, data = <span class="hljs-string">&quot;jsonrpc:89&quot;</span>, res = res&#125;<br>        <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>这四个函数的作用分别是</p>
<ul>
<li>resolve：找出 method 对应的 lua 函数</li>
<li>handle：RPC 主流程（读 json-&gt;找函数-&gt;执行-&gt;回包）</li>
<li>reply：生成符合 JSON-RPC 的响应</li>
<li>proxy：安全执行目标函数</li>
</ul>
<p>解释一些名词</p>
<ul>
<li>RPC：远程过程调用，把”网络请求”变为”函数调用”<ul>
<li>极简工作流程：</li>
</ul>
</li>
</ul>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs livescript">客户端 -&gt; 发送 json 请求 -&gt; 服务器（路由器）执行对应的函数<span class="hljs-function"><span class="hljs-params">(merge/login 等)</span> -&gt;</span> 返回 json 格式的结果 -&gt; 客户端<br></code></pre></td></tr></table></figure>

<ul>
<li>JSON： （JavaScript Object Notation）  最常用的数据交换格式，看起来像是</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;method&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;merge&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;params&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span> <span class="hljs-number">3</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">10</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<ul>
<li>开关机动画，AI API、前后台通信、配置文件全部用的都是 JSON<ul>
<li>特点<ul>
<li>人类可读</li>
<li>语言无关</li>
<li>结构清晰</li>
<li>网络友好</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>下面看上面调用的 handle 函数</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span><span class="hljs-params">(tbl, rawsource, ...)</span></span><br>    <span class="hljs-keyword">local</span> decoder = luci.json.Decoder()<br>    <span class="hljs-keyword">local</span> stat, err = luci.ltn12.pump.all(rawsource, decoder:sink()) <span class="hljs-comment">--把输入源的数据全部泵到解码器的接收器里</span><br>    <span class="hljs-keyword">local</span> json = decoder:get() <span class="hljs-comment">--从 decoder 中获取完整的 json 解码结果</span><br>    <span class="hljs-keyword">local</span> response<br>    <span class="hljs-keyword">local</span> success = <span class="hljs-literal">false</span><br><br>    <span class="hljs-keyword">if</span> stat <span class="hljs-keyword">then</span> <span class="hljs-comment">--判断是否解码成功</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(json.method) == <span class="hljs-string">&quot;string&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-comment">--要求必须有 method 字段并且是字符串</span><br>            <span class="hljs-keyword">local</span> method = resolve(tbl, json.method) <span class="hljs-comment">--将 json.method 传给 resolve，解析出返回给 method</span><br>            <span class="hljs-keyword">if</span> method <span class="hljs-keyword">then</span> <span class="hljs-comment">--如果 method 存在</span><br>                response = reply(json.jsonrpc, json.id, proxy(method, json.params <span class="hljs-keyword">or</span> &#123;&#125;)) <span class="hljs-comment">--使用 proxy 的函数调用方法</span><br>            <span class="hljs-keyword">else</span><br>                response = reply(json.jsonrpc, json.id, <span class="hljs-literal">nil</span>, &#123;code = <span class="hljs-number">-32601</span>, message = <span class="hljs-string">&quot;Method not found.&quot;</span>&#125;)<br>            <span class="hljs-keyword">end</span><br>        <span class="hljs-keyword">else</span><br>            response = reply(json.jsonrpc, json.id, <span class="hljs-literal">nil</span>, &#123;code = <span class="hljs-number">-32600</span>, message = <span class="hljs-string">&quot;Invalid request.&quot;</span>&#125;)<br>        <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">else</span><br>        response = reply(<span class="hljs-string">&quot;2.0&quot;</span>, <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, &#123;code = <span class="hljs-number">-32700</span>, message = <span class="hljs-string">&quot;Parse error.&quot;</span>, err = err&#125;)<br>    <span class="hljs-keyword">end</span><br><br>    <span class="hljs-keyword">return</span> luci.json.Encoder(response, ...):source()<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>主要作用就是把参数 tbl 和 报文中 method 字段传给 resolve 函数</p>
<p>下面看 resolve 函数</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">resolve</span><span class="hljs-params">(mod, method)</span></span><br>    <span class="hljs-keyword">local</span> <span class="hljs-built_in">path</span> = luci.util.split(method, <span class="hljs-string">&quot;.&quot;</span>)<br><br>    <span class="hljs-keyword">for</span> j = <span class="hljs-number">1</span>, #<span class="hljs-built_in">path</span> - <span class="hljs-number">1</span> <span class="hljs-keyword">do</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">type</span>(<span class="hljs-built_in">mod</span>) == <span class="hljs-string">&quot;table&quot;</span> <span class="hljs-keyword">then</span><br>            <span class="hljs-keyword">break</span><br>        <span class="hljs-keyword">end</span><br>        <span class="hljs-built_in">mod</span> = <span class="hljs-built_in">rawget</span>(<span class="hljs-built_in">mod</span>, <span class="hljs-built_in">path</span>[j])<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">mod</span> <span class="hljs-keyword">then</span><br>            <span class="hljs-keyword">break</span><br>        <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-built_in">mod</span> = <span class="hljs-built_in">type</span>(<span class="hljs-built_in">mod</span>) == <span class="hljs-string">&quot;table&quot;</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">rawget</span>(<span class="hljs-built_in">mod</span>, <span class="hljs-built_in">path</span>[#<span class="hljs-built_in">path</span>]) <span class="hljs-keyword">or</span> <span class="hljs-literal">nil</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(<span class="hljs-built_in">mod</span>) == <span class="hljs-string">&quot;function&quot;</span> <span class="hljs-keyword">then</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">mod</span><br>    <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br><br></code></pre></td></tr></table></figure>

<p>主要作用就是解析 method 字段对应的函数，然后赋值给 mod ，返回值给 method ，然后回到 handle 函数中，进入 proxy(method, json.params or {})  第一个参数就是我们上面 resolve 解析出的 method ，第二个时 json.params 字段，如果不存在就传入 {}（空表）</p>
<p>method 中的函数在 noauth.lua 之中，接下来就来看 noauth.lua</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-built_in">module</span>(<span class="hljs-string">&quot;luci.modules.noauth&quot;</span>, <span class="hljs-built_in">package</span>.<span class="hljs-built_in">seeall</span>)<br><br><span class="hljs-comment">-- 登录</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">login</span><span class="hljs-params">(params)</span></span><br>    <span class="hljs-keyword">local</span> disp = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;luci.dispatcher&quot;</span>)<br>    <span class="hljs-keyword">local</span> common = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;luci.modules.common&quot;</span>)<br>    <span class="hljs-keyword">local</span> tool = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;luci.utils.tool&quot;</span>)<br>    <span class="hljs-keyword">if</span> params.password <span class="hljs-keyword">and</span> tool.includeXxs(params.password) <span class="hljs-keyword">then</span><br>        tool.eweblog(<span class="hljs-string">&quot;INVALID DATA&quot;</span>, <span class="hljs-string">&quot;LOGIN FAILED&quot;</span>)<br>        <span class="hljs-keyword">return</span><br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">local</span> authOk<br>    <span class="hljs-keyword">local</span> ua = <span class="hljs-built_in">os</span>.<span class="hljs-built_in">getenv</span>(<span class="hljs-string">&quot;HTTP_USER_AGENT&quot;</span>) <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;unknown brower (ua is nil)&quot;</span><br>    tool.eweblog(ua, <span class="hljs-string">&quot;LOGIN UA&quot;</span>)<br>    <span class="hljs-keyword">local</span> checkStat = &#123;<br>        password = params.password,<br>        username = <span class="hljs-string">&quot;admin&quot;</span>, <span class="hljs-comment">-- params.username,</span><br>        encry = params.encry,<br>        limit = params.limit<br>    &#125;<br>    <span class="hljs-keyword">local</span> authres, reason = tool.checkPasswd(checkStat)<br>    <span class="hljs-keyword">local</span> log_opt = &#123;username = params.username, level = <span class="hljs-string">&quot;auth.notice&quot;</span>&#125;<br>    <span class="hljs-keyword">if</span> authres <span class="hljs-keyword">then</span><br>        authOk = disp.writeSid(<span class="hljs-string">&quot;admin&quot;</span>)<br>        <span class="hljs-comment">-- 手动登录时设置时间</span><br>        <span class="hljs-keyword">if</span> params.<span class="hljs-built_in">time</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">tonumber</span>(params.<span class="hljs-built_in">time</span>) <span class="hljs-keyword">then</span><br>            common.setSysTime(&#123;<span class="hljs-built_in">time</span> = params.<span class="hljs-built_in">time</span>&#125;)<br>        <span class="hljs-keyword">end</span><br>        log_opt.action = <span class="hljs-string">&quot;login-success&quot;</span><br>    <span class="hljs-keyword">else</span><br>        log_opt.action = <span class="hljs-string">&quot;login-fail&quot;</span><br>    <span class="hljs-keyword">end</span><br>    tool.write_log(log_opt)<br>    <span class="hljs-keyword">return</span> authOk<br><span class="hljs-keyword">end</span><br><br><span class="hljs-comment">-- 单点登录</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">singleLogin</span><span class="hljs-params">()</span></span><br>    <span class="hljs-keyword">local</span> sauth = luci.sauth<br>    <span class="hljs-keyword">local</span> fs = <span class="hljs-built_in">require</span> <span class="hljs-string">&quot;nixio.fs&quot;</span><br>    <span class="hljs-keyword">local</span> <span class="hljs-built_in">config</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;luci.config&quot;</span>)<br>    <span class="hljs-built_in">config</span>.sauth = <span class="hljs-built_in">config</span>.sauth <span class="hljs-keyword">or</span> &#123;&#125;<br>    <span class="hljs-keyword">local</span> sessionpath = <span class="hljs-built_in">config</span>.sauth.sessionpath<br>    <span class="hljs-keyword">if</span> sauth.sane() <span class="hljs-keyword">then</span><br>        <span class="hljs-keyword">local</span> id<br>        <span class="hljs-keyword">for</span> id <span class="hljs-keyword">in</span> fs.dir(sessionpath) <span class="hljs-keyword">do</span><br>            sauth.kill(id)<br>        <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br><br><span class="hljs-comment">-- 网络合并</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">merge</span><span class="hljs-params">(params)</span></span><br>    <span class="hljs-keyword">local</span> cmd = <span class="hljs-built_in">require</span> <span class="hljs-string">&quot;luci.modules.cmd&quot;</span><br>    <span class="hljs-keyword">return</span> cmd.devSta.set(&#123;device = <span class="hljs-string">&quot;pc&quot;</span>, <span class="hljs-built_in">module</span> = <span class="hljs-string">&quot;networkId_merge&quot;</span>, data = params, async = <span class="hljs-literal">true</span>&#125;)<br><span class="hljs-keyword">end</span><br><br><span class="hljs-comment">-- ping checknet</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkNet</span><span class="hljs-params">(params)</span></span><br>    <span class="hljs-keyword">if</span> params.host <span class="hljs-keyword">then</span><br>        <span class="hljs-keyword">local</span> tool = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;luci.utils.tool&quot;</span>)<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">string</span>.<span class="hljs-built_in">len</span>(params.host) &gt; <span class="hljs-number">50</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> tool.checkIp(params.host) <span class="hljs-keyword">then</span><br>            <span class="hljs-keyword">return</span> &#123;connect = <span class="hljs-literal">false</span>, msg = <span class="hljs-string">&quot;host illegal&quot;</span>&#125;<br>        <span class="hljs-keyword">end</span><br>        <span class="hljs-keyword">local</span> json = <span class="hljs-built_in">require</span> <span class="hljs-string">&quot;luci.json&quot;</span><br>        <span class="hljs-keyword">local</span> _curl =<br>            <span class="hljs-string">&#x27;curl -s -k -X POST \&#x27;http://%s/cgi-bin/luci/api/auth\&#x27; -H content-type:application/json -d \&#x27;&#123;&quot;method&quot;:&quot;checkNet&quot;&#125;\&#x27;&#x27;</span> %<br>            params.host<br>        <span class="hljs-keyword">local</span> _data = json.decode(luci.sys.exec(_curl))<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(_data) == <span class="hljs-string">&quot;table&quot;</span> <span class="hljs-keyword">then</span><br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(_data.data) == <span class="hljs-string">&quot;table&quot;</span> <span class="hljs-keyword">then</span><br>                <span class="hljs-keyword">return</span> _data.data<br>            <span class="hljs-keyword">end</span><br>            <span class="hljs-keyword">return</span> &#123;connect = <span class="hljs-literal">false</span>&#125;<br>        <span class="hljs-keyword">else</span><br>            <span class="hljs-keyword">return</span> &#123;connect = <span class="hljs-literal">false</span>&#125;<br>        <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">else</span><br>        <span class="hljs-keyword">return</span> &#123;connect = <span class="hljs-literal">true</span>&#125;<br>    <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br><br></code></pre></td></tr></table></figure>

<p>其中，singleLogin 中没有 params ，没可控参数，不用看；checkNet 有 params.host ，并且拼入命令执行字符串，不过前面有 tool.checkIp(params.host) 负责检查，无法绕过；然后就是 login，看起来有许多可控字段：params.password，pawams.encry，params.limit 等，但实际上全部被过滤或者替换掉了。看处理 checkStat 的 tool.checkPasswd</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- 检测密码是否正确</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkPasswd</span><span class="hljs-params">(checkStat)</span></span><br>    <span class="hljs-keyword">local</span> cmd = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;luci.modules.cmd&quot;</span>)<br>    <span class="hljs-keyword">local</span> _data = &#123;<br>        <span class="hljs-built_in">type</span> = checkStat.encry <span class="hljs-keyword">and</span> <span class="hljs-string">&quot;enc&quot;</span> <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;noenc&quot;</span>, <span class="hljs-comment">--这个的意思是，如果 checkStat.encry为真，那么 type=&quot;enc&quot;，为假type=&quot;noenc&quot;</span><br>        password = checkStat.password,<br>        name = checkStat.username,<br>        limit = checkStat.limit <span class="hljs-keyword">and</span> <span class="hljs-string">&quot;true&quot;</span> <span class="hljs-keyword">or</span> <span class="hljs-literal">nil</span><br>    &#125;<br>    <span class="hljs-keyword">local</span> _check = cmd.devSta.get(&#123;<span class="hljs-built_in">module</span> = <span class="hljs-string">&quot;adminCheck&quot;</span>, device = <span class="hljs-string">&quot;pc&quot;</span>, data = _data&#125;)<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(_check) == <span class="hljs-string">&quot;table&quot;</span> <span class="hljs-keyword">and</span> _check.result == <span class="hljs-string">&quot;success&quot;</span> <span class="hljs-keyword">then</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>, _check.reason<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>这里导致 encry 和 limit 变成固定值，不可控了，只剩下 password</p>
<p>然后这里调用了</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-keyword">local</span> _check = cmd.devSta.get(&#123;<span class="hljs-built_in">module</span> = <span class="hljs-string">&quot;adminCheck&quot;</span>, device = <span class="hljs-string">&quot;pc&quot;</span>, data = _data&#125;)<br></code></pre></td></tr></table></figure>

<p>就是调用 cmf 的 devSta 中的 get，下面看 devSta.get</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs lua">devSta[opt[i]] = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(params)</span></span><br>    <span class="hljs-keyword">local</span> model = <span class="hljs-built_in">require</span> <span class="hljs-string">&quot;dev_sta&quot;</span><br>    params.method = opt[i]<br>    params.cfg_cmd = <span class="hljs-string">&quot;dev_sta&quot;</span><br>    <span class="hljs-keyword">local</span> data, back, ip, password, shell = doParams(params)<br>    <span class="hljs-keyword">return</span> fetch(model.fetch, shell, params, opt[i], params.<span class="hljs-built_in">module</span>, data, back, ip, password)<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>首先调用 doParams 对参数处理，接着调用 fetch，先看 doParams</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">doParams</span><span class="hljs-params">(params)</span></span><br>    <span class="hljs-built_in">require</span> <span class="hljs-string">&quot;luci.json&quot;</span><br>    <span class="hljs-comment">-- web接口调用全部去掉时间，强制force设置下去</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(params.data) == <span class="hljs-string">&quot;table&quot;</span> <span class="hljs-keyword">then</span><br>        params.data.currentTime = <span class="hljs-literal">nil</span><br>        params.data.configTime = <span class="hljs-literal">nil</span><br>        params.data.configId = <span class="hljs-literal">nil</span><br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">local</span> tool = <span class="hljs-built_in">require</span> <span class="hljs-string">&quot;luci.utils.tool&quot;</span><br>    <span class="hljs-keyword">if</span> tool.includeXxs(params.<span class="hljs-built_in">module</span>) <span class="hljs-keyword">or</span> tool.includeXxs(params.method) <span class="hljs-keyword">then</span><br>        params.<span class="hljs-built_in">module</span> = <span class="hljs-string">&quot;illegalMoule&quot;</span><br>        params.method = <span class="hljs-string">&quot;illegalMethod&quot;</span><br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">not</span> params.<span class="hljs-built_in">module</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> params.method) <span class="hljs-keyword">then</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;please input module&quot;</span><br>    <span class="hljs-keyword">else</span><br>        <span class="hljs-keyword">local</span> data, back, ip, password = <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span><br><br>        <span class="hljs-keyword">local</span> _shell = params.cfg_cmd .. <span class="hljs-string">&quot; &quot;</span> .. params.method .. <span class="hljs-string">&quot; --module &#x27;&quot;</span> .. params.<span class="hljs-built_in">module</span> .. <span class="hljs-string">&quot;&#x27;&quot;</span><br>        <span class="hljs-comment">-- 远程代理调用</span><br>        <span class="hljs-keyword">if</span> params.remoteIp <span class="hljs-keyword">then</span><br>            _shell = _shell .. <span class="hljs-string">&quot; -i &#x27;&quot;</span> .. params.remoteIp .. <span class="hljs-string">&quot;&#x27;&quot;</span><br>            ip = params.remoteIp<br>        <span class="hljs-keyword">end</span><br>        <span class="hljs-keyword">if</span> params.remotePwd <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> (params.cur) <span class="hljs-keyword">then</span><br>            _shell = _shell .. <span class="hljs-string">&quot; -p &#x27;&quot;</span> .. params.remotePwd .. <span class="hljs-string">&quot;&#x27;&quot;</span><br>            password = params.remotePwd<br>        <span class="hljs-keyword">end</span><br>        <span class="hljs-keyword">if</span> params.data <span class="hljs-keyword">then</span><br>            data = luci.json.encode(params.data)<br>            _shell = _shell .. <span class="hljs-string">&quot; &#x27;&quot;</span> .. data .. <span class="hljs-string">&quot;&#x27;&quot;</span><br>        <span class="hljs-keyword">end</span><br>        <span class="hljs-keyword">if</span> params.async == <span class="hljs-literal">true</span> <span class="hljs-keyword">or</span> params.async == <span class="hljs-string">&quot;true&quot;</span> <span class="hljs-keyword">then</span><br>            back = <span class="hljs-number">0</span><br>            _shell = _shell .. <span class="hljs-string">&quot; -b 0 &quot;</span><br>        <span class="hljs-keyword">elseif</span> params.async == <span class="hljs-literal">false</span> <span class="hljs-keyword">or</span> params.async == <span class="hljs-string">&quot;false&quot;</span> <span class="hljs-keyword">then</span><br>            back = <span class="hljs-number">1</span><br>            _shell = _shell .. <span class="hljs-string">&quot; -b 1 &quot;</span><br>        <span class="hljs-keyword">end</span><br>        <span class="hljs-keyword">return</span> data, back, ip, password, _shell<br>    <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>这里对我们存放在 params.data 里的 password 进行了一些处理</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lua">data = luci.json.encode(params.data)<br></code></pre></td></tr></table></figure>

<p>接下来是处理的函数</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">encode</span><span class="hljs-params">(obj, ...)</span></span><br>	<span class="hljs-keyword">local</span> out = &#123;&#125;<br>	<span class="hljs-keyword">local</span> e = Encoder(obj, <span class="hljs-number">1</span>, ...):source()<br>	<span class="hljs-keyword">local</span> chnk, err<br>	<span class="hljs-keyword">repeat</span><br>		chnk, err = e()<br>		out[#out+<span class="hljs-number">1</span>] = chnk<br>	<span class="hljs-keyword">until</span> <span class="hljs-keyword">not</span> chnk<br>	<span class="hljs-keyword">return</span> <span class="hljs-keyword">not</span> err <span class="hljs-keyword">and</span> <span class="hljs-built_in">table</span>.<span class="hljs-built_in">concat</span>(out) <span class="hljs-keyword">or</span> <span class="hljs-literal">nil</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>这个函数就是对传入的字符串进行 json 编码，会把 \n 字符 编码为 \u00a ，漏洞被补上，所以只剩下 merge</p>
<p>\n 可能导致：</p>
<ul>
<li>注入额外参数，例如 <code>attacker\nrole=admin</code> ，服务端会读取两行</li>
</ul>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><span class="hljs-attribute">username</span><span class="hljs-operator">=</span>attacker<br><span class="hljs-attribute">role</span><span class="hljs-operator">=</span>admin<br></code></pre></td></tr></table></figure>

<p>从而伪造新参数</p>
<p>下面分析 merge</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- 网络合并</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">merge</span><span class="hljs-params">(params)</span></span><br>    <span class="hljs-keyword">local</span> cmd = <span class="hljs-built_in">require</span> <span class="hljs-string">&quot;luci.modules.cmd&quot;</span><br>    <span class="hljs-keyword">return</span> cmd.devSta.set(&#123;device = <span class="hljs-string">&quot;pc&quot;</span>, <span class="hljs-built_in">module</span> = <span class="hljs-string">&quot;networkId_merge&quot;</span>, data = params, async = <span class="hljs-literal">true</span>&#125;)<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>可以看到没有对 params 处理，调用了 devSta.set，接下来看这个的代码</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs lua">devSta[opt[i]] = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(params)</span></span><br>    <span class="hljs-keyword">local</span> model = <span class="hljs-built_in">require</span> <span class="hljs-string">&quot;dev_sta&quot;</span><br>    params.method = opt[i]<br>    params.cfg_cmd = <span class="hljs-string">&quot;dev_sta&quot;</span><br>    <span class="hljs-keyword">local</span> data, back, ip, password, shell = doParams(params)<br>    <span class="hljs-keyword">return</span> fetch(model.fetch, shell, params, opt[i], params.<span class="hljs-built_in">module</span>, data, back, ip, password)<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>data 字段可控（params里的内容）</p>
<p>这里最后调用了 fetch ，下面就来看这个</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fetch</span><span class="hljs-params">(fn, shell, params, ...)</span></span><br>    <span class="hljs-built_in">require</span> <span class="hljs-string">&quot;luci.json&quot;</span><br>    <span class="hljs-keyword">local</span> tool = <span class="hljs-built_in">require</span> <span class="hljs-string">&quot;luci.utils.tool&quot;</span><br>    <span class="hljs-keyword">local</span> _start = <span class="hljs-built_in">os</span>.<span class="hljs-built_in">time</span>()<br>    <span class="hljs-keyword">local</span> _res = fn(...)<br>    tool.eweblog(shell, params.device, <span class="hljs-built_in">os</span>.<span class="hljs-built_in">time</span>() - _start)<br>    <span class="hljs-keyword">if</span> params.method ~= <span class="hljs-string">&quot;get&quot;</span> <span class="hljs-keyword">then</span><br>        tool.write_log(&#123;action = shell&#125;)<br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">if</span> _res.code == <span class="hljs-number">0</span> <span class="hljs-keyword">then</span><br>        _res = _res.data <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;&quot;</span><br>        <span class="hljs-keyword">if</span> params.noParse <span class="hljs-keyword">then</span><br>            <span class="hljs-keyword">return</span> _res<br>        <span class="hljs-keyword">end</span><br>        <span class="hljs-keyword">return</span> _res <span class="hljs-keyword">and</span> luci.json.decode(_res) <span class="hljs-keyword">or</span> (_res <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;&quot;</span>)<br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">return</span> _res<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>这里调用 <code>    local _res = fn(...)</code> 就是 fetch 函数传进来的 model.fetch，而 model 是 dev_sta 的返回结果（devSta[get]中有说明），所以这里调用的实际是 dev_sta 中的 fetch 函数，接下来看这个函数的代码（路径为 &#x2F;usr&#x2F;lib&#x2F;lua&#x2F;dev_sta.lua）</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">--主函数</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fetch</span><span class="hljs-params">(cmd, module, param, back, ip, password, force, not_change_configId, multi)</span></span><br>    <span class="hljs-keyword">local</span> uf_call = <span class="hljs-built_in">require</span> <span class="hljs-string">&quot;libuflua&quot;</span><br>    <span class="hljs-keyword">local</span> ctype<br><br>    ctype = get_ctype()<br>    param = param <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;&quot;</span><br>    ip = ip <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;&quot;</span><br>    password = password <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-keyword">if</span> force <span class="hljs-keyword">and</span> force == <span class="hljs-string">&quot;1&quot;</span> <span class="hljs-keyword">then</span><br>    	force = <span class="hljs-literal">true</span><br>    <span class="hljs-keyword">else</span><br>    	force = <span class="hljs-literal">false</span><br>    <span class="hljs-keyword">end</span><br><br>    <span class="hljs-keyword">if</span> back <span class="hljs-keyword">and</span> back == <span class="hljs-string">&quot;1&quot;</span> <span class="hljs-keyword">then</span><br>    	back = <span class="hljs-literal">true</span><br>    <span class="hljs-keyword">else</span><br>    	back = <span class="hljs-literal">false</span><br>    <span class="hljs-keyword">end</span>   <br><br>    <span class="hljs-keyword">if</span> not_change_configId <span class="hljs-keyword">then</span><br>    	not_change_configId = <span class="hljs-literal">true</span><br>    <span class="hljs-keyword">else</span><br>    	not_change_configId = <span class="hljs-literal">false</span><br>    <span class="hljs-keyword">end</span><br><br>    <span class="hljs-keyword">if</span> multi <span class="hljs-keyword">then</span><br>    	multi = <span class="hljs-literal">true</span><br>    <span class="hljs-keyword">else</span><br>    	multi = <span class="hljs-literal">false</span><br>    <span class="hljs-keyword">end</span><br><br>    <span class="hljs-keyword">local</span> stat = uf_call.client_call(ctype, cmd, <span class="hljs-built_in">module</span>, param, back, ip, password, force, not_change_configId, multi)<br>    <span class="hljs-keyword">return</span> stat<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>可以看到调用了 libuflua.so（Lua扩展库） 中的 client_call 函数，路径是 usr&#x2F;lib&#x2F;lua&#x2F;libuflua.so 下，下面进行分析，用 IDA 打开，没搜索到 client_call 看学习文章说 IDA 大概率没有把 client_call 解析成字符串，而是解析成代码，这里用 010editor 打开，搜索 client_call </p>
<p><img src="/2025/05/19/IO_FILE%20Exploit/1765095173939.png" srcset="/img/loading.gif" lazyload></p>
<p>发现在 0xff0 处，返回 IDA</p>
<p><img src="/2025/05/19/IO_FILE%20Exploit/1765095264944.png" srcset="/img/loading.gif" lazyload></p>
<p>发现确实被当成了代码来解析，选中这部分数据，按 a ，即可以字符串形式呈现</p>
<p><img src="/2025/05/19/IO_FILE%20Exploit/1765095324186.png" srcset="/img/loading.gif" lazyload></p>
<p>寻找交叉调用（哪儿被调用）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __fastcall <span class="hljs-title function_">luaopen_libuflua</span><span class="hljs-params">(<span class="hljs-type">int</span> a1)</span><br>&#123;<br>  luaL_register(a1, <span class="hljs-string">&quot;libuflua&quot;</span>, &amp;off_1101C);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>该函数原型为</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">luaL_register</span> <span class="hljs-params">(lua_State *L, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *libname, <span class="hljs-type">const</span> luaL_Reg *l)</span>;<br></code></pre></td></tr></table></figure>

<p>三个参数：</p>
<ul>
<li>L：Lua 虚拟机的状态机指针，一个结构体，里面包含整个 Lua 环境的所有运行信息，就是当前 Lua 解释器的上下文</li>
<li>libname：给 Lua 模块快起的名字</li>
<li>l：函数映射表，里面包括 Lua 函数名+对应的 C 函数指针</li>
</ul>
<p>所以现在查看 off_1101C 里的内容</p>
<p><img src="/2025/05/19/IO_FILE%20Exploit/1765097769984.png" srcset="/img/loading.gif" lazyload></p>
<p>得出结论，sub_A00 中就是 client_call 中的代码，下面来分析这个</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __fastcall <span class="hljs-title function_">sub_A00</span><span class="hljs-params">(<span class="hljs-type">int</span> a1)</span><br>&#123;<br>  <span class="hljs-type">int</span> v2; <span class="hljs-comment">// $v0</span><br>  <span class="hljs-type">int</span> v3; <span class="hljs-comment">// $s1</span><br>  <span class="hljs-type">int</span> v4; <span class="hljs-comment">// $s3</span><br>  <span class="hljs-type">int</span> v5; <span class="hljs-comment">// $s2</span><br>  <span class="hljs-type">int</span> v6; <span class="hljs-comment">// $v0</span><br>  <span class="hljs-type">int</span> v7; <span class="hljs-comment">// $v1</span><br>  <span class="hljs-type">int</span> v8; <span class="hljs-comment">// $s3</span><br>  <span class="hljs-type">int</span> v9; <span class="hljs-comment">// $a1</span><br>  <span class="hljs-type">int</span> v10; <span class="hljs-comment">// $a0</span><br>  <span class="hljs-type">int</span> v11; <span class="hljs-comment">// $a1</span><br>  <span class="hljs-type">int</span> v13[<span class="hljs-number">3</span>]; <span class="hljs-comment">// [sp+18h] [-Ch] BYREF</span><br><br>  v13[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;<br>  v2 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">52</span>);<br>  v3 = v2;<br>  <span class="hljs-keyword">if</span> ( v2 )<br>  &#123;<br>    <span class="hljs-built_in">memset</span>(v2, <span class="hljs-number">0</span>, <span class="hljs-number">52</span>);<br>    v5 = <span class="hljs-number">4</span>;<br>    *(_DWORD *)v3 = luaL_checkinteger(a1, <span class="hljs-number">1</span>);<br>    *(_DWORD *)(v3 + <span class="hljs-number">4</span>) = luaL_checklstring(a1, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>);<br>    v6 = luaL_checklstring(a1, <span class="hljs-number">3</span>, <span class="hljs-number">0</span>);<br>    v7 = *(_DWORD *)v3;<br>    *(_DWORD *)(v3 + <span class="hljs-number">8</span>) = v6;<br>    <span class="hljs-keyword">if</span> ( v7 != <span class="hljs-number">3</span> )<br>    &#123;<br>      *(_DWORD *)(v3 + <span class="hljs-number">12</span>) = lua_tolstring(a1, <span class="hljs-number">4</span>, <span class="hljs-number">0</span>);<br>      *(_BYTE *)(v3 + <span class="hljs-number">41</span>) = lua_toboolean(a1, <span class="hljs-number">5</span>) == <span class="hljs-number">1</span>;<br>      v5 = <span class="hljs-number">6</span>;<br>      *(_BYTE *)(v3 + <span class="hljs-number">40</span>) = <span class="hljs-number">1</span>;<br>    &#125;<br>    *(_DWORD *)(v3 + <span class="hljs-number">20</span>) = lua_tolstring(a1, v5, <span class="hljs-number">0</span>);<br>    *(_DWORD *)(v3 + <span class="hljs-number">24</span>) = lua_tolstring(a1, v5 + <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);<br>    v8 = v5 + <span class="hljs-number">2</span>;<br>    <span class="hljs-keyword">if</span> ( *(_DWORD *)v3 )<br>    &#123;<br>      <span class="hljs-keyword">if</span> ( *(_DWORD *)v3 == <span class="hljs-number">2</span> )<br>      &#123;<br>        v8 = v5 + <span class="hljs-number">3</span>;<br>        *(_BYTE *)(v3 + <span class="hljs-number">43</span>) = lua_toboolean(a1, v5 + <span class="hljs-number">2</span>) == <span class="hljs-number">1</span>;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>      *(_BYTE *)(v3 + <span class="hljs-number">43</span>) = lua_toboolean(a1, v5 + <span class="hljs-number">2</span>) == <span class="hljs-number">1</span>;<br>      v8 = v5 + <span class="hljs-number">4</span>;<br>      *(_BYTE *)(v3 + <span class="hljs-number">44</span>) = lua_toboolean(a1, v5 + <span class="hljs-number">3</span>) == <span class="hljs-number">1</span>;<br>    &#125;<br>    *(_BYTE *)(v3 + <span class="hljs-number">48</span>) = lua_toboolean(a1, v8) == <span class="hljs-number">1</span>;<br>    v4 = uf_client_call(v3, v13, <span class="hljs-number">0</span>);<br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>    v13[<span class="hljs-number">0</span>] = strdup(<span class="hljs-string">&quot;memory full!&quot;</span>);<br>    v4 = <span class="hljs-number">-1</span>;<br>  &#125;<br>  lua_createtable(a1, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>  lua_pushstring(a1, <span class="hljs-string">&quot;code&quot;</span>);<br>  <span class="hljs-keyword">if</span> ( v4 )<br>  &#123;<br>    lua_pushnumber(a1, v9, loc_1000, loc_1004);<br>    lua_rawset(a1, <span class="hljs-number">-3</span>);<br>    lua_pushstring(a1, <span class="hljs-string">&quot;err&quot;</span>);<br>    lua_pushstring(a1, v13[<span class="hljs-number">0</span>]);<br>    lua_rawset(a1, <span class="hljs-number">-3</span>);<br>    lua_pushstring(a1, <span class="hljs-string">&quot;data&quot;</span>);<br>    v10 = a1;<br>    v11 = <span class="hljs-number">0</span>;<br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>    lua_pushnumber(a1, v9, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    lua_rawset(a1, <span class="hljs-number">-3</span>);<br>    lua_pushstring(a1, <span class="hljs-string">&quot;err&quot;</span>);<br>    lua_pushstring(a1, <span class="hljs-number">0</span>);<br>    lua_rawset(a1, <span class="hljs-number">-3</span>);<br>    lua_pushstring(a1, <span class="hljs-string">&quot;data&quot;</span>);<br>    v11 = v13[<span class="hljs-number">0</span>];<br>    v10 = a1;<br>  &#125;<br>  lua_pushstring(v10, v11);<br>  lua_rawset(a1, <span class="hljs-number">-3</span>);<br>  <span class="hljs-keyword">if</span> ( v13[<span class="hljs-number">0</span>] )<br>    <span class="hljs-built_in">free</span>();<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>可以看到在 52 行调用了 uf_client_call，在文件系统下搜索该字符串</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh">yy@yy-virtual-machine:~/桌面/CVE-2023-34644/_EW_3.0.1.B11P204_EW1200GI_09243000_install.bin.extrted/squashfs-root$ grep -r <span class="hljs-string">&quot;uf_client_call&quot;</span> ./<br>匹配到二进制文件 ./usr/lib/lua/libuflua.so<br>匹配到二进制文件 ./usr/lib/libunifyframe.so<br>匹配到二进制文件 ./usr/sbin/uf_sys<br>匹配到二进制文件 ./usr/sbin/uf_ubus_call.elf<br>匹配到二进制文件 ./usr/sbin/unifyframe-sgi.elf<br></code></pre></td></tr></table></figure>

<p>匹配到以下库，再回到 libuflua.so 中看到</p>
<p><img src="/2025/05/19/IO_FILE%20Exploit/1765204723652.png" srcset="/img/loading.gif" lazyload></p>
<p>所以可以判断出 uf_client_call 函数在 .&#x2F;usr&#x2F;lib&#x2F;libunifyframe.so 之中，用 IDA 打开查看</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __fastcall <span class="hljs-title function_">uf_client_call</span><span class="hljs-params">(<span class="hljs-type">int</span> a1, <span class="hljs-type">int</span> a2, <span class="hljs-type">int</span> a3)</span><br>&#123;<br>.....<br>  <span class="hljs-keyword">switch</span> ( *(_DWORD *)a1 )<span class="hljs-comment">//这里 *a1 指的是 uf_call.client_call 函数的第一个参数 ctype，取决于 method，在 dev_sta.lua 中赋值为 2</span><br>  &#123;<br>.....<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>      v7 = ((<span class="hljs-type">int</span> (*)(<span class="hljs-type">void</span>))<span class="hljs-built_in">strlen</span>)() + <span class="hljs-number">8</span>;<br>      v8 = <span class="hljs-built_in">calloc</span>(v7, <span class="hljs-number">1</span>);<br>      v9 = <span class="hljs-number">433</span>;<br>      <span class="hljs-keyword">if</span> ( !v8 )<br>        <span class="hljs-keyword">goto</span> LABEL_20;<br>      v10 = v8;<br>      v11 = v7;<br>      v12 = <span class="hljs-string">&quot;devSta.%s&quot;</span>;<br>      <span class="hljs-keyword">goto</span> LABEL_22;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:<br>      v15 = ((<span class="hljs-type">int</span> (*)(<span class="hljs-type">void</span>))<span class="hljs-built_in">strlen</span>)() + <span class="hljs-number">8</span>;<br>      v8 = <span class="hljs-built_in">calloc</span>(v15, <span class="hljs-number">1</span>);<br>      v9 = <span class="hljs-number">463</span>;<br>      <span class="hljs-keyword">if</span> ( !v8 )<br>        <span class="hljs-keyword">goto</span> LABEL_20;<br>      v10 = v8;<br>      v11 = v15;<br>      v12 = <span class="hljs-string">&quot;devCap.%s&quot;</span>;<br>      <span class="hljs-keyword">goto</span> LABEL_22;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>:<br>      v16 = ((<span class="hljs-type">int</span> (*)(<span class="hljs-type">void</span>))<span class="hljs-built_in">strlen</span>)() + <span class="hljs-number">7</span>;<br>      v17 = <span class="hljs-built_in">calloc</span>(v16, <span class="hljs-number">1</span>);<br>      v8 = v17;<br>      <span class="hljs-keyword">if</span> ( !v17 )<br>      &#123;<br>        v9 = <span class="hljs-number">473</span>;<br>LABEL_20:<br>        uf_log_printf(uf_log, <span class="hljs-string">&quot;ERROR (%s %s %d)malloc failed!&quot;</span>, <span class="hljs-string">&quot;lib_unifyframe.c&quot;</span>, <span class="hljs-string">&quot;uf_client_call&quot;</span>, v9);<br>        <span class="hljs-keyword">goto</span> LABEL_24;<br>      &#125;<br>      v10 = v17;<br>      v11 = v16;<br>      v12 = <span class="hljs-string">&quot;ufSys.%s&quot;</span>;<br>LABEL_22:<span class="hljs-comment">//这里下面用大量 json_object_object_add 函数</span><br>      <span class="hljs-keyword">if</span> ( <span class="hljs-built_in">snprintf</span>(v10, v11, v12, v6) &lt; <span class="hljs-number">0</span> )<br>      &#123;<br>        <span class="hljs-built_in">free</span>(v8);<br>LABEL_24:<br>        json_object_put(v4);<br>        syslog(<span class="hljs-number">3</span>, <span class="hljs-string">&quot;(%s %s %d)method snprintf failed&quot;</span>, <span class="hljs-string">&quot;lib_unifyframe.c&quot;</span>, <span class="hljs-string">&quot;uf_client_call&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>      &#125;<br>      v18 = json_object_new_string(v8);<br>      <span class="hljs-built_in">free</span>(v8);<br>      <span class="hljs-keyword">if</span> ( !v18 )<br>      &#123;<br>        json_object_put(v4);<br>        syslog(<span class="hljs-number">3</span>, <span class="hljs-string">&quot;(%s %s %d)new obj_method failed&quot;</span>, <span class="hljs-string">&quot;lib_unifyframe.c&quot;</span>, <span class="hljs-string">&quot;uf_client_call&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>      &#125;<br>      json_object_object_add(v4, <span class="hljs-string">&quot;method&quot;</span>, v18);<br>      v19 = json_object_new_object();<br>      <span class="hljs-keyword">if</span> ( !v19 )<br>      &#123;<br>        json_object_put(v4);<br>        syslog(<span class="hljs-number">3</span>, <span class="hljs-string">&quot;(%s %s %d)new obj_param failed&quot;</span>, <span class="hljs-string">&quot;lib_unifyframe.c&quot;</span>, <span class="hljs-string">&quot;uf_client_call&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>      &#125;<br>      v20 = json_object_new_string(*(_DWORD *)(a1 + <span class="hljs-number">8</span>));<br>      <span class="hljs-keyword">if</span> ( !v20 )<br>      &#123;<br>        json_object_put(v19);<br>        json_object_put(v4);<br>        syslog(<span class="hljs-number">3</span>, <span class="hljs-string">&quot;(%s %s %d)new obj_module failed&quot;</span>, <span class="hljs-string">&quot;lib_unifyframe.c&quot;</span>, <span class="hljs-string">&quot;uf_client_call&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>      &#125;<br>      json_object_object_add(v19, <span class="hljs-string">&quot;module&quot;</span>, v20);<br>      v21 = *(_DWORD *)(a1 + <span class="hljs-number">20</span>);<br>      <span class="hljs-keyword">if</span> ( !v21 )<br>        <span class="hljs-keyword">goto</span> LABEL_34;<br>      v22 = json_object_new_string(v21);<br>      <span class="hljs-keyword">if</span> ( !v22 )<br>        <span class="hljs-keyword">goto</span> LABEL_40;<br>      json_object_object_add(v19, <span class="hljs-string">&quot;remoteIp&quot;</span>, v22);<br>LABEL_34:<br>      v23 = *(_DWORD *)(a1 + <span class="hljs-number">24</span>);<br>      <span class="hljs-keyword">if</span> ( v23 )<br>      &#123;<br>        v24 = json_object_new_string(v23);<br>        <span class="hljs-keyword">if</span> ( !v24 )<br>        &#123;<br>          json_object_put(v19);<br>          json_object_put(v4);<br>          syslog(<span class="hljs-number">3</span>, <span class="hljs-string">&quot;(%s %s %d)new obj_passwd failed&quot;</span>, <span class="hljs-string">&quot;lib_unifyframe.c&quot;</span>, <span class="hljs-string">&quot;uf_client_call&quot;</span>);<br>          <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>        &#125;<br>        json_object_object_add(v19, <span class="hljs-string">&quot;remotePwd&quot;</span>, v24);<br>      &#125;<br>      <span class="hljs-keyword">if</span> ( *(_DWORD *)(a1 + <span class="hljs-number">36</span>) )<br>      &#123;<br>        v25 = json_object_new_int();<br>        <span class="hljs-keyword">if</span> ( !v25 )<br>        &#123;<br>LABEL_40:<br>          json_object_put(v19);<br>          json_object_put(v4);<br>          syslog(<span class="hljs-number">3</span>, <span class="hljs-string">&quot;(%s %s %d)new obj_remoteip failed&quot;</span>, <span class="hljs-string">&quot;lib_unifyframe.c&quot;</span>, <span class="hljs-string">&quot;uf_client_call&quot;</span>);<br>          <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>        &#125;<br>        json_object_object_add(v19, <span class="hljs-string">&quot;buf&quot;</span>, v25);<br>      &#125;<br>      <span class="hljs-keyword">if</span> ( *(_DWORD *)a1 )<br>      &#123;<br>        <span class="hljs-keyword">if</span> ( *(_DWORD *)a1 != <span class="hljs-number">2</span> )<br>        &#123;<br>          v26 = *(<span class="hljs-type">unsigned</span> __int8 *)(a1 + <span class="hljs-number">45</span>);<br>          <span class="hljs-keyword">goto</span> LABEL_56;<br>        &#125;<br>        <span class="hljs-keyword">if</span> ( *(_BYTE *)(a1 + <span class="hljs-number">42</span>) )<br>        &#123;<br>          v28 = json_object_new_boolean(<span class="hljs-number">1</span>);<br>          <span class="hljs-keyword">if</span> ( v28 )<br>          &#123;<br>            v29 = v19;<br>            v30 = <span class="hljs-string">&quot;execute&quot;</span>;<br>            <span class="hljs-keyword">goto</span> LABEL_54;<br>          &#125;<br>        &#125;<br>      &#125;<br>      <span class="hljs-keyword">else</span><br>      &#123;<br>        <span class="hljs-keyword">if</span> ( *(_BYTE *)(a1 + <span class="hljs-number">43</span>) )<br>        &#123;<br>          v27 = json_object_new_boolean(<span class="hljs-number">1</span>);<br>          <span class="hljs-keyword">if</span> ( v27 )<br>            json_object_object_add(v19, <span class="hljs-string">&quot;force&quot;</span>, v27);<br>        &#125;<br>        <span class="hljs-keyword">if</span> ( *(_BYTE *)(a1 + <span class="hljs-number">44</span>) )<br>        &#123;<br>          v28 = json_object_new_boolean(<span class="hljs-number">1</span>);<br>          <span class="hljs-keyword">if</span> ( v28 )<br>          &#123;<br>            v29 = v19;<br>            v30 = <span class="hljs-string">&quot;configId_not_change&quot;</span>;<br>LABEL_54:<br>            json_object_object_add(v29, v30, v28);<br>          &#125;<br>        &#125;<br>      &#125;<br>      v26 = *(<span class="hljs-type">unsigned</span> __int8 *)(a1 + <span class="hljs-number">45</span>);<br>LABEL_56:<br>      <span class="hljs-keyword">if</span> ( v26 )<br>      &#123;<br>        v31 = json_object_new_boolean(<span class="hljs-number">1</span>);<br>        <span class="hljs-keyword">if</span> ( v31 )<br>          json_object_object_add(v19, <span class="hljs-string">&quot;from_url&quot;</span>, v31);<br>      &#125;<br>      <span class="hljs-keyword">if</span> ( *(_BYTE *)(a1 + <span class="hljs-number">47</span>) )<br>      &#123;<br>        v32 = json_object_new_boolean(<span class="hljs-number">1</span>);<br>        <span class="hljs-keyword">if</span> ( v32 )<br>          json_object_object_add(v19, <span class="hljs-string">&quot;from_file&quot;</span>, v32);<br>      &#125;<br>      <span class="hljs-keyword">if</span> ( *(_BYTE *)(a1 + <span class="hljs-number">48</span>) )<br>      &#123;<br>        v33 = json_object_new_boolean(<span class="hljs-number">1</span>);<br>        <span class="hljs-keyword">if</span> ( v33 )<br>          json_object_object_add(v19, <span class="hljs-string">&quot;multi&quot;</span>, v33);<br>      &#125;<br>      <span class="hljs-keyword">if</span> ( *(_BYTE *)(a1 + <span class="hljs-number">46</span>) )<br>      &#123;<br>        v34 = json_object_new_boolean(<span class="hljs-number">1</span>);<br>        <span class="hljs-keyword">if</span> ( v34 )<br>          json_object_object_add(v19, <span class="hljs-string">&quot;not_commit&quot;</span>, v34);<br>      &#125;<br>      <span class="hljs-keyword">if</span> ( *(_BYTE *)(a1 + <span class="hljs-number">40</span>) )<br>      &#123;<br>        v35 = json_object_new_boolean(*(<span class="hljs-type">unsigned</span> __int8 *)(a1 + <span class="hljs-number">41</span>) ^ <span class="hljs-number">1</span>);<br>        <span class="hljs-keyword">if</span> ( v35 )<br>          json_object_object_add(v19, <span class="hljs-string">&quot;async&quot;</span>, v35);<br>      &#125;<br>      v36 = *(_BYTE **)(a1 + <span class="hljs-number">12</span>);<br>      <span class="hljs-keyword">if</span> ( !v36 || !*v36 )<br>        <span class="hljs-keyword">goto</span> LABEL_75;<br>      v37 = json_object_new_string(v36);<br>      <span class="hljs-keyword">if</span> ( !v37 )<br>        <span class="hljs-keyword">goto</span> LABEL_78;<br>      json_object_object_add(v19, <span class="hljs-string">&quot;data&quot;</span>, v37);<br>LABEL_75:<br>      v38 = *(_BYTE **)(a1 + <span class="hljs-number">16</span>);<br>      <span class="hljs-keyword">if</span> ( v38 &amp;&amp; *v38 )<br>      &#123;<br>        v39 = json_object_new_string(v38);<br>        <span class="hljs-keyword">if</span> ( !v39 )<br>        &#123;<br>LABEL_78:<br>          json_object_put(v19);<br>          json_object_put(v4);<br>          syslog(<span class="hljs-number">3</span>, <span class="hljs-string">&quot;(%s %s %d)new obj_data failed&quot;</span>, <span class="hljs-string">&quot;lib_unifyframe.c&quot;</span>, <span class="hljs-string">&quot;uf_client_call&quot;</span>);<br>          <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>        &#125;<br>        json_object_object_add(v19, <span class="hljs-string">&quot;device&quot;</span>, v39);<br>      &#125;<br>      json_object_object_add(v4, <span class="hljs-string">&quot;params&quot;</span>, v19);<br>      v40 = json_object_to_json_string(v4);<span class="hljs-comment">//转换为 json 格式的字符串</span><br>      <span class="hljs-keyword">if</span> ( !v40 )<br>      &#123;<br>        json_object_put(v4);<br>        syslog(<span class="hljs-number">3</span>, <span class="hljs-string">&quot;(%s %s %d)new json_object_to_json_string send buf failed&quot;</span>, <span class="hljs-string">&quot;lib_unifyframe.c&quot;</span>, <span class="hljs-string">&quot;uf_client_call&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>      &#125;<br>      v41 = uf_socket_client_init(<span class="hljs-number">0</span>);<br>      <span class="hljs-keyword">if</span> ( v41 &lt;= <span class="hljs-number">0</span> )<br>      &#123;<br>        json_object_put(v4);<br>        v42 = *(<span class="hljs-type">const</span> <span class="hljs-type">char</span> **)(a1 + <span class="hljs-number">12</span>);<br>        v43 = *(<span class="hljs-type">const</span> <span class="hljs-type">char</span> **)(a1 + <span class="hljs-number">4</span>);<br>        v44 = *(<span class="hljs-type">const</span> <span class="hljs-type">char</span> **)(a1 + <span class="hljs-number">8</span>);<br>        v45 = *(_DWORD *)(a1 + <span class="hljs-number">16</span>);<br>        <span class="hljs-keyword">if</span> ( v42 )<br>        &#123;<br>          <span class="hljs-keyword">if</span> ( v45 )<br>          &#123;<br>            syslog(<br>              <span class="hljs-number">3</span>,<br>              <span class="hljs-string">&quot;(%s %s %d)uf_socket_client_init failed, caller: %s [ctype:%d  %s -m %s %s]&quot;</span>,<br>              <span class="hljs-string">&quot;lib_unifyframe.c&quot;</span>,<br>              <span class="hljs-string">&quot;uf_client_call&quot;</span>,<br>              <span class="hljs-number">651</span>,<br>              *(<span class="hljs-type">const</span> <span class="hljs-type">char</span> **)(a1 + <span class="hljs-number">16</span>),<br>              *(_DWORD *)a1,<br>              v43,<br>              v44,<br>              v42);<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>          &#125;<br>          syslog(<br>            <span class="hljs-number">3</span>,<br>            <span class="hljs-string">&quot;(%s %s %d)uf_socket_client_init failed, [ctype:%d  %s -m %s %s]&quot;</span>,<br>            <span class="hljs-string">&quot;lib_unifyframe.c&quot;</span>,<br>            <span class="hljs-string">&quot;uf_client_call&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">else</span><br>        &#123;<br>          <span class="hljs-keyword">if</span> ( !v45 )<br>          &#123;<br>            syslog(<br>              <span class="hljs-number">3</span>,<br>              <span class="hljs-string">&quot;(%s %s %d)uf_socket_client_init failed, [ctype:%d %s -m %s]&quot;</span>,<br>              <span class="hljs-string">&quot;lib_unifyframe.c&quot;</span>,<br>              <span class="hljs-string">&quot;uf_client_call&quot;</span>,<br>              <span class="hljs-number">662</span>,<br>              *(_DWORD *)a1,<br>              v43,<br>              v44);<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>          &#125;<br>          syslog(<br>            <span class="hljs-number">3</span>,<br>            <span class="hljs-string">&quot;(%s %s %d)uf_socket_client_init failed, caller: %s [ctype:%d %s -m %s]&quot;</span>,<br>            <span class="hljs-string">&quot;lib_unifyframe.c&quot;</span>,<br>            <span class="hljs-string">&quot;uf_client_call&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>      &#125;<br>      v46 = <span class="hljs-built_in">strlen</span>(v40);<br>      uf_socket_msg_write(v41, v40, v46); <span class="hljs-comment">//最终调用 uf_socket_msg_write</span><br>      json_object_put(v4);<br>      <span class="hljs-keyword">if</span> ( *(_BYTE *)(a1 + <span class="hljs-number">40</span>) &amp;&amp; *(_BYTE *)(a1 + <span class="hljs-number">41</span>) )<br>      &#123;<br>        uf_socket_close(v41);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>      &#125;<br>      v56 = <span class="hljs-number">1</span> &lt;&lt; (v41 &amp; <span class="hljs-number">0x1F</span>);<br>      v47 = &amp;v53[<span class="hljs-number">4</span> * ((<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)v41 &gt;&gt; <span class="hljs-number">5</span>)];<br>      v48 = <span class="hljs-number">0</span>;<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">default</span>:<br>      <span class="hljs-keyword">goto</span> LABEL_24;<br>  &#125;<br>  <span class="hljs-keyword">while</span> ( <span class="hljs-number">1</span> )<br>  &#123;<br>    v50 = <span class="hljs-number">4</span> * v48;<br>    <span class="hljs-keyword">if</span> ( v48 &lt; <span class="hljs-number">0x20</span> )<br>      <span class="hljs-keyword">goto</span> LABEL_98;<br>    *(_DWORD *)v47 |= v56;<br>    v51 = select(v41 + <span class="hljs-number">1</span>, v53, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> ( !v51 )<br>    &#123;<br>      uf_socket_close(v41);<br>      syslog(<span class="hljs-number">3</span>, <span class="hljs-string">&quot;(%s %s %d)select timeout[%s]&quot;</span>, <span class="hljs-string">&quot;lib_unifyframe.c&quot;</span>, <span class="hljs-string">&quot;uf_client_call&quot;</span>);<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> ( v51 &gt;= <span class="hljs-number">0</span> )<br>      <span class="hljs-keyword">break</span>;<br>    v49 = (_DWORD *)_errno_location();<br>    <span class="hljs-keyword">if</span> ( (*v49 &amp; <span class="hljs-number">0xFFFFFFF7</span>) != <span class="hljs-number">4</span> )<br>    &#123;<br>      uf_socket_close(v41);<br>      strerror(*v49);<br>      syslog(<span class="hljs-number">3</span>, <span class="hljs-string">&quot;(%s %s %d)select error %s&quot;</span>, <span class="hljs-string">&quot;lib_unifyframe.c&quot;</span>, <span class="hljs-string">&quot;uf_client_call&quot;</span>);<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    syslog(<span class="hljs-number">3</span>, <span class="hljs-string">&quot;(%s %s %d)socket EINTR or ENOMEM [%d]&quot;</span>, <span class="hljs-string">&quot;lib_unifyframe.c&quot;</span>, <span class="hljs-string">&quot;uf_client_call&quot;</span>, <span class="hljs-number">691</span>, *v49);<br>    v48 = <span class="hljs-number">0</span>;<br>    v50 = <span class="hljs-number">0</span>;<br>LABEL_98:<br>    *(_DWORD *)&amp;v53[v50] = <span class="hljs-number">0</span>;<br>    ++v48;<br>  &#125;<br>  <span class="hljs-keyword">if</span> ( ((*(<span class="hljs-type">int</span> *)v47 &gt;&gt; (v41 &amp; <span class="hljs-number">0x1F</span>)) &amp; <span class="hljs-number">1</span>) != <span class="hljs-number">0</span> )<br>  &#123;<br>    v52 = uf_socket_msg_read(v41, a2);<br>    uf_socket_close(v41);<br>    <span class="hljs-keyword">if</span> ( v52 &gt;= <span class="hljs-number">1</span> )<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">return</span> v52;<br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>    syslog(<span class="hljs-number">3</span>, <span class="hljs-string">&quot;(%s %s %d)FD_ISSET failed[%s]&quot;</span>, <span class="hljs-string">&quot;lib_unifyframe.c&quot;</span>, <span class="hljs-string">&quot;uf_client_call&quot;</span>, <span class="hljs-number">710</span>, *(<span class="hljs-type">const</span> <span class="hljs-type">char</span> **)(a1 + <span class="hljs-number">8</span>));<br>    uf_socket_close(v41);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>json_object_object_add 是一个 json-c 库里的函数，用来向 json 对象中添加键值，比如</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c">json_object_object_add(obj, <span class="hljs-string">&quot;name&quot;</span>, json_object_new_string(<span class="hljs-string">&quot;admin&quot;</span>));<br>json_object_object_add(obj, <span class="hljs-string">&quot;id&quot;</span>, json_object_new_int(<span class="hljs-number">1</span>));<br><span class="hljs-comment">//生成的 json 就是</span><br><span class="hljs-comment">//&#123;</span><br><span class="hljs-comment">// 	name&quot;: &quot;admin&quot;</span><br><span class="hljs-comment">//	id&quot;: 1</span><br><span class="hljs-comment">//&#125;</span><br></code></pre></td></tr></table></figure>

<p>socket基础概念</p>
<ul>
<li><p>socket 是操作系统提供的网络编程接口，用于描述计算机之间通信的断点</p>
</li>
<li><p>通过 socket，程序可以</p>
<ul>
<li>发送数据</li>
<li>接收数据</li>
<li>监听端口</li>
<li>建立连接</li>
</ul>
</li>
<li><p>在我们刚刚分析的程序中，就是通过 socket 将构造好的 json 字符串发送给另一个进程</p>
</li>
<li><p>不同类型的 socket</p>
<ul>
<li><p>流式套接字：</p>
<ul>
<li><p>底层协议：TCP</p>
</li>
<li><ul>
<li><p><strong>特性</strong>：</p>
<ul>
<li>面向连接</li>
<li>提供可靠、顺序、完整的字节流传输</li>
<li>会处理丢包重传和拥塞控制</li>
</ul>
<p><strong>典型用途</strong>：</p>
<ul>
<li>HTTP 请求 &#x2F; 响应</li>
<li>FTP 上传&#x2F;下载</li>
<li>SSH 远程登录</li>
</ul>
<p><strong>在固件中</strong>：</p>
<ul>
<li><code>uf_client_call</code> 很可能使用 TCP socket 向 libunifyframe 的守护进程发送 JSON RPC。</li>
<li>数据顺序和完整性很重要，因此用 TCP。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>数据报套接字（Datagram Socket &#x2F; <code>SOCK_DGRAM</code>）</p>
</li>
</ul>
<ul>
<li><strong>底层协议</strong>：UDP（用户数据报协议）</li>
<li><strong>特性</strong>：<ul>
<li>无连接</li>
<li>不保证可靠性</li>
<li>消息是独立的，每个 <code>sendto</code> 对应一个 <code>recvfrom</code></li>
</ul>
</li>
<li><strong>典型用途</strong>：<ul>
<li>DNS 查询</li>
<li>视频直播 &#x2F; 语音传输</li>
<li>物联网设备广播发现</li>
</ul>
</li>
<li><strong>在固件中</strong>：<ul>
<li>如果某些功能要求快速、低延迟通信，但可以丢包，可能用 UDP socket。</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>所以猜测，既然有 uf_socket_msg_write 发送数据，那就肯定有地方来接收数据，uf_socket_msg_read，在文件系统下搜索</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">yy@yy-virtual-machine:~/桌面/CVE-2023-34644/_EW_3.0.1.B11P204_EW1200GI_09243000_install.bin.extracted/squashfs-root$ grep -r uf_socket_msg_read ./<br>匹配到二进制文件 ./usr/lib/lighttpd/mod_unifyframe.so<br>匹配到二进制文件 ./usr/lib/libunifyframe.so<br>匹配到二进制文件 ./usr/sbin/unifyframe-sgi.elf<br></code></pre></td></tr></table></figure>

<p>发现 .&#x2F;usr&#x2F;sbin&#x2F;unifyframe-sgi.elf，并且该文件还位于 &#x2F;etc&#x2F;init.d 出现</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">./etc/init.d/unifyframe-sgi:PROG=/usr/sbin/unifyframe-sgi.elf<br></code></pre></td></tr></table></figure>

<p>而 &#x2F;etc&#x2F;init.d 中存放的是系统服务启动脚本的目录，所以该进程从启动就一直存在，所以判断出 unifyframe-sgi.elf 文件就是接收 libunifyframe.so 中发来的数据的</p>
<h1 id="二进制文件分析"><a href="#二进制文件分析" class="headerlink" title="二进制文件分析"></a>二进制文件分析</h1><p>这里借用 zikh26 师傅画的整体的流程图</p>
<p><img src="/2025/05/19/IO_FILE%20Exploit/1766162836354.png" srcset="/img/loading.gif" lazyload></p>
<h1 id="学习文章"><a href="#学习文章" class="headerlink" title="学习文章"></a>学习文章</h1><p> <a target="_blank" rel="noopener" href="https://zikh26.github.io/posts/e5651b4f.html#%E5%89%8D%E8%A8%80">站在巨人肩膀上复现CVE-2023-34644 | ZIKH26’s Blog</a> </p>
<p> [<a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-277386.htm">原创] 记一次全设备通杀未授权RCE的挖掘经历-智能设备-看雪论坛-安全社区|非营利性质技术交流社区</a> </p>
<p> <a target="_blank" rel="noopener" href="https://s1nec-1o.github.io/2024/05/30/CVE-2023-34644%E5%A4%8D%E7%8E%B0/">CVE-2023-34644复现 | S1nec-1o’s B1og</a>   </p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/" class="print-no-link">#漏洞复现</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>CVE-2023-34644复现</div>
      <div>http://yyyffff.github.io/2025/11/20/CVE-2023-34644复现/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>yyyffff</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2025年11月20日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2026/02/11/%E5%88%9D%E6%8E%A2tcache_perthread_struct%E4%B8%8Esetcontext/" title="初探tcache_perthread_struct与setcontext">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">初探tcache_perthread_struct与setcontext</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/10/30/2025%E5%BC%BA%E7%BD%91%E6%9D%AF%E7%BA%BF%E4%B8%8A%E8%B5%9B%E9%83%A8%E5%88%86pwn%E5%A4%8D%E7%8E%B0/" title="2025强网杯线上赛部分pwn复现">
                        <span class="hidden-mobile">2025强网杯线上赛部分pwn复现</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.5.1/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"2bkS2AvQTqNk4TIsyxh4ew9q-gzGzoHsz","appKey":"GfRH0zMaM1USTNT6w25DTqu8","path":"window.location.pathname","placeholder":"说点什么","avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":false,"serverURLs":"","emojiCDN":null,"emojiMaps":null,"enableQQ":false},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        总访问量 
        <span id="leancloud-site-pv"></span>
         次
      </span>
    
    
      <span id="leancloud-site-uv-container" style="display: none">
        总访客数 
        <span id="leancloud-site-uv"></span>
         人
      </span>
    
    

  

</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
